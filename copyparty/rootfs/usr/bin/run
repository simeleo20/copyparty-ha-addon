#!/bin/sh

set -e

# --- 1. CONFIGURAZIONE E SETUP ---

# jq dovrebbe essere disponibile nell'immagine base. 
SHARED_FOLDER_NAME=$(jq --raw-output ".SHARED_FOLDER_NAME" /data/options.json)

HA_SHARE_PATH="/share/${SHARED_FOLDER_NAME}"

echo "Ensuring user-defined shared directory exists at: ${HA_SHARE_PATH}"

mkdir -p "${HA_SHARE_PATH}"

# --- 2. DEFINIZIONE DELLE CARTELLE DA CONDIVIDERE (Lista semplice) ---

# Definisce i percorsi del filesystem di Home Assistant da condividere 
# Usa uno spazio come separatore.
SHARE_PATHS="/config::HA_Config /share::HA_Shared /media::HA_Media /ssl::HA_SSL_Certs /addons::HA_Addon_Data /backup::HA_Backups"

# --- 3. COSTRUZIONE DEGLI ARGOMENTI DI COPYPARTY ---
echo "Starting CopyParty on port 3923, sharing multiple paths..."

COPYPARTY_ARGS=""

# Iterazione sulla stringa di percorsi (compatibile con SH)
for path_map in ${SHARE_PATHS}; do
  COPYPARTY_ARGS="${COPYPARTY_ARGS} ${path_map}"
done

# --- 4. AVVIO DI COPYPARTY (UTILIZZANDO EXEC) ---

# Usa 'exec' e python3
exec python3 -m copyparty --addr 0.0.0.0 --port 3923 ${COPYPARTY_ARGS}