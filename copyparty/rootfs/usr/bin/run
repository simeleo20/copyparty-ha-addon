#!/bin/sh

set -e

# --- 1. CONFIGURAZIONE E SETUP ---

SHARED_FOLDER_NAME=$(jq --raw-output ".SHARED_FOLDER_NAME" /data/options.json)
HA_SHARE_PATH="/share/${SHARED_FOLDER_NAME}"

echo "Ensuring user-defined shared directory exists at: ${HA_SHARE_PATH}"
mkdir -p "${HA_SHARE_PATH}"

# --- 2. AVVIO DI COPYPARTY (RISOLUZIONE ARGOMENTI CON SH -C) ---

echo "Starting CopyParty on port 3923, sharing multiple paths..."

# !!! CORREZIONE DEFINITIVA PER BUSYBOX !!!
# Usare 'sh -c' costringe la shell a interpretare la stringa come un comando, 
# garantendo che gli spazi separino gli argomenti e risolvendo l'errore.
exec sh -c "python3 -m copyparty --addr 0.0.0.0 --port 3923 '/config::HA_Config' '/share::HA_Shared' '/media::HA_Media' '/ssl::HA_SSL_Certs' '/addons::HA_Addon_Data' '/backup::HA_Backups'"